<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research System - Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        .card {
            margin-bottom: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-error {
            background-color: #dc3545;
        }
        .status-unknown {
            background-color: #ffc107;
        }
        .status-unreachable {
            background-color: #6c757d;
        }
        .refresh-btn {
            margin-left: 15px;
        }
        .system-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .progress {
            height: 10px;
            margin-bottom: 15px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .last-update {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 15px;
        }
        .tools-list {
            font-size: 0.85em;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h1>Research System Dashboard</h1>
                <p class="text-muted">Simple monitoring interface for debugging and development</p>
                <p class="last-update">
                    Last updated: {{ last_update }}
                    <button id="refresh-btn" class="btn btn-sm btn-outline-secondary refresh-btn">
                        <span id="refresh-icon">â†»</span> Refresh
                    </button>
                    <span id="auto-refresh-label" class="ms-3">Auto-refresh: </span>
                    <div class="form-check form-switch d-inline-block ms-2">
                        <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                    </div>
                </p>
            </div>
        </div>

        <div class="row">
            <!-- System Status Section -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="system-metric">
                            <span>CPU Usage:</span>
                            <span>{{ system_status.cpu_percent }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: {{ system_status.cpu_percent }}%"
                                 aria-valuenow="{{ system_status.cpu_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>

                        <div class="system-metric">
                            <span>Memory Usage:</span>
                            <span>{{ system_status.memory_percent }}% ({{ system_status.memory_used }})</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-info" role="progressbar" 
                                 style="width: {{ system_status.memory_percent }}%"
                                 aria-valuenow="{{ system_status.memory_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>

                        <div class="system-metric">
                            <span>Disk Usage:</span>
                            <span>{{ system_status.disk_percent }}% ({{ system_status.disk_used }})</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ system_status.disk_percent }}%"
                                 aria-valuenow="{{ system_status.disk_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>

                <!-- Database Status Card -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Database</h5>
                        <span class="badge {{ 'bg-success' if db_status.status == 'connected' else 'bg-danger' }}">
                            {{ db_status.status }}
                        </span>
                    </div>
                    <div class="card-body">
                        <p><strong>Type:</strong> {{ db_status.type }}</p>
                        <p><strong>Location:</strong> {{ db_status.location }}</p>
                        <p><strong>Tasks:</strong> {{ tasks_count }}</p>
                        <p><strong>Results:</strong> {{ results_count }}</p>
                        {% if db_status.status == 'error' %}
                        <div class="alert alert-danger">
                            {{ db_status.error }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Agents Status Section -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Agents Status</h5>
                        <span class="badge bg-primary">{{ agents|length }} Registered</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Agent</th>
                                        <th>Status</th>
                                        <th>Description</th>
                                        <th>Tools</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for name, agent in agents.items() %}
                                    <tr>
                                        <td>{{ name }}</td>
                                        <td>
                                            <span class="status-indicator status-{{ agent.status }}"></span>
                                            {{ agent.status }}
                                        </td>
                                        <td>{{ agent.description }}</td>
                                        <td class="tools-list">
                                            {{ agent.tools|join(", ") }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Recent Tasks Section -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Tasks</h5>
                    </div>
                    <div class="card-body">
                        {% if recent_tasks %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in recent_tasks %}
                                    <tr>
                                        <td><code>{{ task.id[:8] }}...</code></td>
                                        <td>{{ task.title }}</td>
                                        <td>
                                            <span class="badge {{ 'bg-success' if task.status == 'completed' 
                                                          else 'bg-warning' if task.status == 'in_progress' 
                                                          else 'bg-danger' if task.status == 'failed'
                                                          else 'bg-secondary' }}">
                                                {{ task.status }}
                                            </span>
                                        </td>
                                        <td>{{ task.created_at }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No tasks available</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Recent Results Section -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Results</h5>
                    </div>
                    <div class="card-body">
                        {% if recent_results %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Task ID</th>
                                        <th>Format</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in recent_results %}
                                    <tr>
                                        <td><code>{{ result.id[:8] }}...</code></td>
                                        <td><code>{{ result.task_id[:8] }}...</code></td>
                                        <td>{{ result.format }}</td>
                                        <td>
                                            <span class="badge {{ 'bg-success' if result.status == 'final' 
                                                          else 'bg-warning' if result.status == 'reviewed' 
                                                          else 'bg-secondary' }}">
                                                {{ result.status }}
                                            </span>
                                        </td>
                                        <td>{{ result.created_at }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No results available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Refresh button functionality
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshIcon = document.getElementById('refresh-icon');
            const autoRefreshCheckbox = document.getElementById('auto-refresh');
            
            let refreshInterval;
            
            // Function to refresh the page
            function refreshPage() {
                refreshIcon.classList.add('rotate');
                location.reload();
            }
            
            // Click handler for manual refresh
            refreshBtn.addEventListener('click', refreshPage);
            
            // Auto-refresh functionality
            function startAutoRefresh() {
                // Clear any existing interval
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
                
                // Set new interval (every 10 seconds)
                if (autoRefreshCheckbox.checked) {
                    refreshInterval = setInterval(refreshPage, 10000);
                }
            }
            
            // Toggle auto-refresh when checkbox changes
            autoRefreshCheckbox.addEventListener('change', startAutoRefresh);
            
            // Initialize auto-refresh if checked
            startAutoRefresh();
            
            // Add rotating animation
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes rotate {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                .rotate {
                    display: inline-block;
                    animation: rotate 1s linear infinite;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>